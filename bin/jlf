#!/usr/bin/env python
"""
Get forward looking metrics from JIRA
"""

from jira_stats.jira_wrapper import JiraWrapper
from jira_stats import publisher

import json
from datetime import datetime, timedelta
import argparse
import os

def main():

    parser = argparse.ArgumentParser(description='Get forward looking metrics from JIRA')

    parser.add_argument('-n',
                        action="store",
                        dest="num_weeks",
                        type=int,
                        default=6)

    parser.add_argument('-c',
                        action="store",
                        dest="config_filename",
                        default='config.json')

    parser.add_argument('-s',
                        action="store",
                        dest="swimlane_category",
                        default=None)

    args = parser.parse_args()

    config_file = open(args.config_filename)
    config = json.load(config_file)

    our_jira = JiraWrapper(config=config)

    end_date = datetime.now()
    start_date = end_date - timedelta(weeks=args.num_weeks)

    report_config = {'name':     'reports',
                     'reports':  [{'metric':     'throughput',
                                   'categories': 'foreach',
                                   'types':      'foreach'},
                                  {'metric':     'cumulative-throughput',
                                   'categories': 'foreach',
                                   'types':      'foreach'},
                                  {'metric':     'demand',
                                   'categories': 'foreach',
                                   'types':      ['failure']},
                                  {'metric':     'done',
                                   'categories': 'foreach',
                                   'types':      'foreach',
                                   'sort':       'week-done'},
                                  {'metric':     'cycle-time',
                                   'categories': 'foreach',
                                   'types':      ['value'],
                                   'cycles':     ['develop']}],
                     'format':   'xlsx',
                     'location': os.getcwd()}

    publisher.publish(report_config,
                      our_jira,
                      from_date=start_date.date(),
                      to_date=end_date.date())        
    

if __name__ == "__main__":
    main()
